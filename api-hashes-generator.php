<?php
/*
 API Hash file generator for WordPress Exploit Scanner
 Author: mattyrob
 Author URI: http://subscribe2.wordpress.com/
*/

$version_url = 'https://api.wordpress.org/core/version-check/1.7/';

$versions = file_get_contents( $version_url );
$versions = json_decode( $versions );

foreach( $versions->offers as $wp_version ) {
	create_hashes( $wp_version->version );
}

if ( isset( $_GET['version'] ) ) {
	create_hashes( $_GET['version'] );
}

function create_hashes( $wp_version ) {
	$checksum_url = 'https://api.wordpress.org/core/checksums/1.0/?version=';
	$locale = '&locale=en_US';
	$filename = dirname( __FILE__ ) . '/' . 'hashes-' . $wp_version . '.php';
	if ( ! file_exists( $filename ) ) {
		$checksums = file_get_contents( $checksum_url . $wp_version . $locale );
		$checksums = json_decode( $checksums, true );
		$hashes = "<?php\n" . '$filehashes = array(' . "\n";
		foreach ( $checksums['checksums'] as $file => $checksum ) {
			if ( stripos( $file, 'wp-content' ) !== 0 ) {
				$hashes .= "\t'" . $file . "' => '" . $checksum . "',\n";
			}
		}
		$hashes .= ");\n";
		file_put_contents( $filename, $hashes );
		echo 'Hash file created for ' . $wp_version . "\n";
	}
}
